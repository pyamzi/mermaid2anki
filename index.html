<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mermaid to SVG Embed</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js"></script>
<style>
body { font-family: sans-serif; padding: 1rem; max-width: 700px; margin: auto; }
textarea { width: 100%; height: 200px; font-family: monospace; }
button { margin-top: 1rem; padding: 0.5rem 1rem; }
#output { margin-top: 1.5rem; border: 1px solid #ccc; padding: 1rem; }
#linkBox { margin-top: 1rem; width: 100%; }
</style>
</head>
<body>

<h2>Mermaid â†’ SVG Embed</h2>
<textarea id="input" placeholder="Enter Mermaid diagram code here...">graph TD
  A[Start] --> B{Is it working?}
  B -- Yes --> C[Great!]
  B -- No --> D[Fix it]</textarea>
<br>
<button id="renderBtn">Render</button>
<div id="output"></div>
<input id="linkBox" readonly placeholder="Your SVG embed link will appear here" />

<script>
mermaid.initialize({ startOnLoad: false, securityLevel: 'antiscript' });

const input = document.getElementById("input");
const output = document.getElementById("output");
const linkBox = document.getElementById("linkBox");

document.getElementById("renderBtn").addEventListener("click", async () => {
  const text = input.value.trim();
  output.innerHTML = "Rendering...";

  try {
    // Use mermaid.parse if available to detect syntax errors early
    if (typeof mermaid.parse === 'function') {
      mermaid.parse(text);
    }
  } catch (parseErr) {
    output.textContent = 'Mermaid syntax error:\n' + (parseErr && (parseErr.str || parseErr.message || parseErr));
    linkBox.value = '';
    return;
  }

  try {
    // Render to SVG string
    const id = 'mmd-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    const { svg } = await mermaid.render(id, text);

    // Parse the SVG string into a real DOM node so we can embed it as <svg>
    const parser = new DOMParser();
    const doc = parser.parseFromString(svg, 'image/svg+xml');
    const svgEl = doc.documentElement;

    // Clear previous output and append the SVG element
    output.innerHTML = '';
    // Import the node into current document to avoid ownership issues
    const imported = document.importNode(svgEl, true);
    // Ensure the svg has xmlns attribute for embedding
    if (!imported.getAttribute('xmlns')) imported.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    output.appendChild(imported);

    // Create a proper data URL. Use base64 for safety with Netlify / data URIs.
    const serializer = new XMLSerializer();
    const svgText = serializer.serializeToString(imported);
    const base64 = btoa(unescape(encodeURIComponent(svgText)));
    const dataURL = `data:image/svg+xml;base64,${base64}`;
    linkBox.value = dataURL;
  } catch (err) {
    output.textContent = 'Error rendering Mermaid diagram:\n' + (err && (err.message || err));
    linkBox.value = '';
  }
});

// Auto-render the example on load
// Auto-render the example on load
window.addEventListener('DOMContentLoaded', () => {
  // Auto-click the render button to reuse the same logic
  document.getElementById('renderBtn').click();
});
</script>

</body>
</html>
